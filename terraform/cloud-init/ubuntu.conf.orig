#cloud-config
package_upgrade: false

runcmd:
  - export LANG="en_US.UTF-8"
  - export DEBIAN_FRONTEND=noninteractive
  - |
    timeout=300  # 300 seconds = 5 minutes
    while [ $timeout -gt 0 ]
    do
      if ping -c1 -t 1 8.8.8.8 &>/dev/null; then
        timeout=0
      else
        sleep 1
        echo "waiting for internet ${timeout}"
        ((timeout--))
      fi
    done
  - curl -s -o /tmp/Install-DVWA.sh -L https://raw.githubusercontent.com/robinmordasiewicz/DVWA-Script/main/Install-DVWA.sh
  - chmod 755 /tmp/Install-DVWA.sh
  - /tmp/Install-DVWA.sh
  - sed -i "s/\$_DVWA\[ 'disable_authentication' \] = false;/\$_DVWA[ 'disable_authentication' ] = true;/" /var/www/html/DVWA/config/config.inc.php
  - sed -i "s/\$_DVWA\[ 'default_security_level' \] = 'impossible';/\$_DVWA[ 'default_security_level' ] = 'low';/" /var/www/html/DVWA/config/config.inc.php
  - a2dismod -f deflate
  - ufw allow in "Apache"
  - systemctl restart apache2
  - sleep 2
  - echo "Reset DVWA database"
  - 'curl -v "http://127.0.0.1/DVWA/setup.php" -H "content-type: application/x-www-form-urlencoded" --data-raw "create_db=Create+%2F+Reset+Database&user_token=2f8fa4713b03f1ef496772c7f8a53e88"'
